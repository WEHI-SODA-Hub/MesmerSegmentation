# MIBI preprocessing workflows

Current aim is to test [mcmicro](https://mcmicro.org/parameters/core.html) for segmentation using mesmer.

## Segmentation

### Identifying channel mappings

Env with tifffile:

```bash
conda activate /vast/projects/SODA/envs/tiffenv
```

Extracting channel mapping from TIFFs:

```python
import tifffile
import json

file="/vast/projects/SODA/test_data/MIBI/NSCLC_images/11MH0285_2_0.tiff"

with tifffile.TiffFile(file) as tif:
    for idx,page in enumerate(tif.pages):
        for tag in page.tags.values():
            tag_name, tag_value = tag.name, tag.value
            if tag_name == "ImageDescription":
                x = json.loads(tag_value)
                print(f"{idx+1}: {x['channel.target']}") 
```

Gives the following channels:

```
1: Beta-Tubulin
2: CD103
3: CD11c
4: CD14
5: CD16
6: CD163
7: CD20
8: CD206
9: CD3
10: CD39
11: CD4
12: CD45
13: CD45RA
14: CD45RO
15: CD49a
16: CD56
17: CD66b
18: CD68
19: CD69
20: CD8a
21: CTLA4
22: dsDNA
23: dTCR
24: Foxp3
25: GrzB
26: ICOS
27: IFN-y
28: Ki67
29: LAG3
30: MHC I (HLA Class1)
31: MHC II (HLA-DR)
32: OX40
33: panCK
34: PD1
35: PDL1
36: Tim3
37: Tryptase
38: Vimentin
```

Nuclei channel: `22` (dsDNA)
Membrane channels: `30 33` (MHCI, panCK)

This is also needed to create the `markers.csv` file:

```csv
cycle,marker_name
1,Beta-Tubulin
2,CD103
3,CD11c
4,CD14
5,CD16
6,CD163
7,CD20
8,CD206
9,CD3
10,CD39
11,CD4
12,CD45
13,CD45RA
14,CD45RO
15,CD49a
16,CD56
17,CD66b
18,CD68
19,CD69
20,CD8a
21,CTLA4
22,dsDNA
23,dTCR
24,Foxp3
25,GrzB
26,ICOS
27,IFN-y
28,Ki67
29,LAG3
30,MHCI
31,MHCII
32,OX40
33,panCK
34,PD1
35,PDL1
36,Tim3
37,Tryptase
38,Vimentin
```

### Calculating microns-per-pixel

To calculating microns per pixel (mpp), need to find these fields in the
`metadata = tiff.pages[0].tags['ImageDescription'].value` field (remember, need
to convert this to json):
```
'fovSizeMicrons': 800
'frameSize': 2048
```
This indicates that the mpp value is 0.39 (800/2048).

### Converting to OME-tiff

The regular multi-channel TIFFs need to be converted to OME-TIFF to work with
mcmicro. 

Conversion using bftools is super easy. First install bftools:

```bash
cd ~/apps
wget https://downloads.openmicroscopy.org/bio-formats/7.3.1/artifacts/bftools.zip
unzip bftools.zip && rm bftools.zip
ln -s ~/apps/bftools/bfconvert ~/bin/
```

Now conversion:

```bash
bfconvert 11MH0285_2_0.tiff 11MH0285_2_0.ome.tiff
```

Now need to put the image under `samplename/registration`.

### Running mcmicro

Used this to test (after downloading test data), it worked once I set default
run params in my `wehi.config` file (for some reason the pipeline doesn't
specify any default run params).

```bash
module load nextflow/latest
export NXF_SINGULARITY_CACHEDIR=/vast/projects/SODA/containers/
cd ~/projects/MIBI-workflows/mcmicro
nextflow run main.nf --in exemplar-001 -profile singularity,debug -config ~/nextflow/profiles/wehi.config
```

Running real data as:

```bash
cd /vast/projects/SODA/mcmicro
nextflow run ~/projects/MIBI-workflows/mcmicro/main.nf \
    --params MIBI-NSLC_params.yml \
    --in NSLC \
    -profile singularity \
    -c ~/nextflow/profiles/wehi.config \
    -w $vast/nextflow/work
```

### Channel bug

The following error is thrown by `recyze.py`. 

```
Channel out of range
```

This corresponds to [this line of code](https://github.com/labsyspharm/mcmicro/blob/master/roadie/scripts/recyze.py#L59). 
When I debug, my tiff looks like this:

```
(Pdb) self.in_data
<zarr.core.Array (38, 2048, 2048) float32>
```

But recyse is checking the `self.in_data[0]` dimension for some reason, which is
a 2D array in my data:

```
(Pdb) self.in_data[0].ndim
2
```

This indicates that it has a different array dimension order than what was
generated by bfconvert. I have tried changing the order in bfconvert, but this
has made no difference:

```bash
bfconvert -swap XYZCT $soda/test_data/MIBI/NSCLC_images/11MH0285_2_0.tiff 11MH0285_2_0.test.ome.tiff
```
